# 1_input and run model.Rmd#

This script is to input all the data and run the SIMPLE HIV model for a specified
project.

```{r Initialise}
##setwd("C:/Users/wrx05/Documents/GitHub/phdproject/simplehivmodel")

#######################r initialization####################
# Clear workspace
rm(list=ls()) 

# Source to current directory and set working directory
basePath <- getwd()
library(dplyr)
# Restart R and set working directory to source file location. 

##r User inputs
##select project
selectedproject<- "COVID-19impact"

# Various directories
projectFolder <- file.path(basePath,"projects", selectedproject)
dataFolder <- file.path(basePath,"projects", selectedproject,"data")
resultsFolder <- file.path(basePath,"projects", selectedproject, "output")
figFolder <- file.path(basePath,"projects", selectedproject,"figures")
Rcode <- file.path(basePath, "code") 

# Load standard libraries, key functions and options
# source(file.path(Rcode, "LoadLibrary.R"))
# source(file.path(Rcode, "DataLibraries.R"))
source(file.path(Rcode, "SimpleHiv.R"))
source(file.path(Rcode, "BetaOption.R"))
source(file.path(Rcode, "Parameters.R"))

```


```{r Input}
# Specify project input files and load them
hivdefaultFile<- file.path(dataFolder,  "hiv_default_para.csv")
hivDefaultpara<-read.csv(hivdefaultFile,fileEncoding = 'UTF-8-BOM')

hivfixeddataFile<- file.path(dataFolder,  "hiv_fixed_data.csv")
hivFixeddata<-read.csv(hivfixeddataFile,fileEncoding = 'UTF-8-BOM')

hivtimeseriesFile<- file.path(dataFolder,  "hiv_time_series_data_optimal.csv")
hivTimeseries<-read.csv(hivtimeseriesFile,fileEncoding = 'UTF-8-BOM')

specificationsFile<- file.path(dataFolder,  "project_specs.csv")
projectSpecs<-read.csv(specificationsFile,fileEncoding = 'UTF-8-BOM')

##Scenarios file##
prepScenario3File<- file.path(dataFolder,  "prep_estimate_predicted_use.csv")
prepScenario3<-read.csv(prepScenario3File,fileEncoding = 'UTF-8-BOM')
condomScenario3File<- file.path(dataFolder,  "condom_estimate_predicted_use_20240117.csv")
condomScenario3<-read.csv(condomScenario3File,fileEncoding = 'UTF-8-BOM')
#####data<-cbind(data1,data2)

# From project files extract key project parameters ----------------------------

times<- as.numeric(projectSpecs$steps) 
startyear<- as.numeric(projectSpecs$startyear) 
projectParams <- Parameters(hivDefaultpara, hivFixeddata, hivTimeseries, projectSpecs) #Default params

adjustedPara <- projectParams
# Set-up initial conditions - same for all scenarios
initial_state_values<-as.list(c(N=hivFixeddata$value[hivFixeddata$Para == "plhiv"],                                            
                              I=hivFixeddata$value[hivFixeddata$Para == "newinf"],#new infections
                              d=hivFixeddata$value[hivFixeddata$Para == "prodiag"]))#proportion diagnosed

##############debugonce(SimpleHIV)
```

```{r Set-up scenarios}

#Script for reading scenario parameters returning a list of parameter sets
#load scenarios
source(file.path(projectFolder, "GenerateScenarios.R"))
scenarios <- GenerateScenarios(adjustedPara)
projectSpecs$nscenarios <- length(scenarios)
##For scenario 2 model without COVID-19

```



```{r running model}
#all results in one dataset
infectionresults<-data.frame( 
                       timestep = integer(),
                       scenarios = character(),
                       newHIV = numeric(),
                       totalHIV = numeric(),
                       percentage_diagnosis = numeric(),
                       diagnosis = numeric())
###diagnosis<-list()
for (ii in 1:projectSpecs$nscenarios) {
  output<- SimpleHIV(times=times, 
                     state = initial_state_values,
                     parameters = scenarios[[ii]])
  infectionresults<-rbind(infectionresults,data.frame( 
                       timestep = c(0:(times-1)),
                       scenarios = ii,
                       newHIV = output$I,
                       totalHIV = output$N[1:times],
                       percentage_diagnosis = output$d[1:times],
                       diagnosis = output$diagnosis[1:times]))
}

ylabels <- c()
for (ii in 1:projectSpecs$nscenarios) {
    ylabels[ii] <- scenarios[[ii]]$label
}

infectionresults$scenarios<-factor(infectionresults$scenarios,levels =  
                                      c(1:projectSpecs$nscenarios),labels = ylabels)

###add a column of cumulated number of new infections
#mutate(group_by(newinfectionresults,scenarios), csum=cumsum(newHIV))
infectionresults<- infectionresults %>% group_by(scenarios) %>% mutate(csum_infection = cumsum(newHIV))
###add a colum of the variable "year"###
infectionresults$year<-c(2019,rep(2020,12),rep(2021,12),rep(2022,8),2019,rep(2020,12),rep(2021,12),rep(2022,8),2019,rep(2020,12),rep(2021,12),rep(2022,8))
#newinfectionresults$year<-rep(c(rep("year0",3),rep("year1",12),rep("year2",12),rep("year3",6)),3)
infectionresults <- infectionresults %>%
group_by(scenarios,year) %>%
  mutate(csum_year_infection=cumsum(newHIV))
infectionresults <- infectionresults %>%
group_by(scenarios,year) %>%
  mutate(csum_year_diagnosis=cumsum(diagnosis))

#Run model for all scenarios at once
##Generate the number of new infections per time step in different scenarios
newinfectionresults<-data.frame( 
                       timestep = integer(),
                       scenarios = character(),
                       newHIV = numeric())
###diagnosis<-list()
for (ii in 1:projectSpecs$nscenarios) {
  output<- SimpleHIV(times=times, 
                     state = initial_state_values,
                     parameters = scenarios[[ii]])
  newinfectionresults<-rbind(newinfectionresults,data.frame( 
                       timestep = c(0:(times-1)),
                       scenarios = ii,
                       newHIV = output$I))
}

ylabels <- c()
for (ii in 1:projectSpecs$nscenarios) {
    ylabels[ii] <- scenarios[[ii]]$label
}

newinfectionresults$scenarios<-factor(newinfectionresults$scenarios,levels =  
                                      c(1:projectSpecs$nscenarios),labels = ylabels)

###add a column of cumulated number of new infections
#mutate(group_by(newinfectionresults,scenarios), csum=cumsum(newHIV))
newinfectionresults<- newinfectionresults %>% group_by(scenarios) %>% mutate(csum = cumsum(newHIV))
###add a colum of the variable "year"###
newinfectionresults$year<-c(2019,rep(2020,12),rep(2021,12),rep(2022,8),2019,rep(2020,12),rep(2021,12),rep(2022,8),2019,rep(2020,12),rep(2021,12),rep(2022,8))
#newinfectionresults$year<-rep(c(rep("year0",3),rep("year1",12),rep("year2",12),rep("year3",6)),3)
newinfections_peryear <- newinfectionresults %>%
group_by(scenarios,year) %>%
  summarise(Sum=sum(newHIV))

##Generate the number of total infections per timestep in different scenarios
totalinfectionresults<-data.frame( 
                       timestep = integer(),
                       scenarios = character(),
                       totalHIV = numeric())

for (ii in 1:projectSpecs$nscenarios) {
  output<- SimpleHIV(times=times, 
                     state = initial_state_values,
                     parameters = scenarios[[ii]])
  totalinfectionresults<-rbind(totalinfectionresults,data.frame( 
                               timestep = c(0:times),
                               scenarios = ii,
                               totalHIV = output$N))
}

totalinfectionresults$scenarios<-factor(totalinfectionresults$scenarios,levels =  
                                      c(1:projectSpecs$nscenarios),labels = ylabels)


#Save output in some form Rda file and/or csv
# If file not already created make sure it is not overwritten
if (!file.exists(file.path(resultsFolder, "infectionresults0305.csv"))) {
write.csv(infectionresults, file = file.path(resultsFolder, "infectionresults0305.csv"))
}
if (!file.exists(file.path(resultsFolder, "totalinfection_results1213_2.csv"))) {
write.csv(totalinfectionresults, file = file.path(resultsFolder, "totalinfection_results1213_2.csv"))
}
if (!file.exists(file.path(resultsFolder, "newinfections_peryear1216.csv"))) {
write.csv(newinfections_peryear, file = file.path(resultsFolder, "newinfections_peryear1216.csv"))
}
```



```{r simulation}
numsims <- 1000 # number of sampled parameter sets to run
  # Generate and store a random integer for set.seed so we can rerun 
  # things exactly if we want to
  currseed <- 839381# sample(1:10^6, 1)# 839381 all95:237965
  set.seed(currseed)
  
 paramsSets <- list()
 params2sampleOnce <- c("plhiv", "newinf", "prodiag", "proART", "prosupp", "PrEPcov", "conduse", "sexact", "testpro", "effisupp", "effiPrEP", "efficon")
    params2sampletwice <- c("acts","condoms","testing","prep","immigrants","emigrants","Deaths","tau","sigma") 
    
        #paramsSets[["year"]] <- rep(years, numsims)
    
    # Fixed parameters
    for (var in params2sampleOnce) {
      # Sample from parameter range and duplicate across years
      temp <- runif(numsims,( hivFixeddata %>% filter(Para == var))$lower, 
        (hivFixeddata %>% filter(Para == var))$upper) 
  
      
      paramsSets[[var]] <- temp
    }
  
  #paramsSets

temporal_data<-  as.data.frame(cbind(acts=c(hivTimeseries$acts),
                                     condoms=c(hivTimeseries$condoms), 
                                     testing= c(hivTimeseries$testing),
                                     prep=c(hivTimeseries$prep),
                                     immigrants=c(hivTimeseries$immigrants),
                                     emigrants=c(hivTimeseries$emigrants),
                                     Deaths=c(hivTimeseries$Deaths),
                                     tau=c(hivTimeseries$tau),
                                     sigma=c(hivTimeseries$sigma)))

temporal_data<-as.list(temporal_data)

# Time varying parameters - sampled from multiplicative factor range at each 
    # end and then connect linearly to change the best estimate values.  
    for (var in params2sampletwice) {
      
      tempStart <-  runif(numsims,(hivFixeddata %>% 
          filter(Para == paste0(var, "_range")))$lower, 
        (hivFixeddata %>% filter(Para == paste0(var,"_range")))$upper)
      tempEnd <- runif(numsims,(hivFixeddata %>% 
          filter(Para == paste0(var, "_range")))$lower, 
        (hivFixeddata %>% filter(Para == paste0(var, "_range")))$upper)
      
      # Update best estimate using sampled multiplicative factors for each sim
      varVector <- vector()
      for (ii in 1:numsims) {
        
        varVector <- c(varVector, seq(tempStart[ii], tempEnd[ii], length = times)*
        temporal_data[[var]])
        
        paramsSets[[var]] <- varVector
        
      }
      varVector_base <- vector()
      for (ii in 1:numsims) {
        
        varVector_base <- c(varVector_base, seq(tempStart[ii], tempEnd[ii], length = times))
        paramsSets[[paste0(var, "_base")]] <- varVector_base
        
      }
    }

paramsSets$condoms_scenario3<-paramsSets$condoms_base*condomScenario3$relativenumber
paramsSets$prep_scenario3<- paramsSets$prep_base*prepScenario3$relativenumber
#paramsSets
infectionresults_sim<-data.frame( 
                       timestep = integer(),
                       scenarios = character(),
                       numsim = integer(),
                       newHIV = numeric(),
                       totalHIV = numeric(),
                       percentage_diagnosis = numeric(),
                       diagnosis = numeric())

newinfectionresults_sim<-data.frame( 
                       timestep = integer(),
                       scenarios = character(),
                       numsim = integer(),
                       newHIV = numeric())

totalinfectionresults_sim<-data.frame( 
                       timestep = integer(),
                       scenarios = character(),
                       numsim = integer(),
                       totalHIV = numeric())

 for (ii in 1:numsims) {
output_sim_COVID <-list()
parasets_lists_COVID <- list(c(1:numsims))
parasets_lists_COVID[[ii]]<- c(N0= paramsSets$plhiv[ii], 
               I0=paramsSets$newinf[ii], 
               d0=paramsSets$prodiag[ii], 
               tau0=paramsSets$proART[ii], 
               sigma0=paramsSets$prosupp[ii] ,
               phi=paramsSets$effisupp[ii],  
               omega0= paramsSets$PrEPcov[ii], 
               epsilon_PrEP=paramsSets$effiPrEP[ii],  
               epsilon_condom=paramsSets$efficon[ii],   
               chi_0=paramsSets$conduse[ii], 
               alpha0=paramsSets$sexact[ii],  
               T= paramsSets$testpro[ii])
parasets_lists_COVID[[ii]]$beta0 <- betaoption1(parameters = parasets_lists_COVID[[ii]])
parasets_lists_COVID[[ii]]$alpha_t=c(1,paramsSets$acts[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_COVID[[ii]]$chi_t= c(1,paramsSets$condoms[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_COVID[[ii]]$T_p= c(1,paramsSets$testing[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_COVID[[ii]]$omega_p= c(1,paramsSets$prep[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_COVID[[ii]]$IM= paramsSets$immigrants[((ii-1)*times+1):((ii-1)*times+times)]
parasets_lists_COVID[[ii]]$EM= paramsSets$emigrants[((ii-1)*times+1):((ii-1)*times+times)]
parasets_lists_COVID[[ii]]$Death= paramsSets$Deaths[((ii-1)*times+1):((ii-1)*times+times)]
parasets_lists_COVID[[ii]]$tau= c(paramsSets$proART[ii],paramsSets$tau[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_COVID[[ii]]$sigma= c(paramsSets$prosupp[ii],paramsSets$sigma[((ii-1)*times+2):((ii-1)*times+times)])

initial_state_values_sim_COVID<-list()
initial_state_values_sim_COVID[[ii]]<-as.list(c(N=parasets_lists_COVID[[ii]]$N0,  
                                    I=parasets_lists_COVID[[ii]]$I0,
                                    d=parasets_lists_COVID[[ii]]$d0))
output_sim_COVID[[ii]]<- SimpleHIV(times=times, 
                     state = initial_state_values_sim_COVID[[ii]],
                     parameters = parasets_lists_COVID[[ii]])

infectionresults_sim<-rbind(infectionresults_sim,data.frame( 
                       timestep = c(0:(times-1)),
                       scenarios = "With COVID-19 impact",
                       numsim = ii,
                       newHIV = output_sim_COVID[[ii]]$I, 
                       totalHIV = output_sim_COVID[[ii]]$N[1:times],
                       percentage_diagnosis = output_sim_COVID[[ii]]$d[1:times],
                       diagnosis = output_sim_COVID[[ii]]$diagnosis[1:times]))

newinfectionresults_sim<-rbind(newinfectionresults_sim,data.frame( 
                       timestep = c(0:(times-1)),
                       scenarios = "With COVID-19 impact",
                       numsim = ii,
                       newHIV = output_sim_COVID[[ii]]$I))

totalinfectionresults_sim<-rbind(totalinfectionresults_sim,data.frame( 
                       timestep = c(0:times),
                       scenarios = "With COVID-19 impact",
                       numsim = ii,
                       totalHIV = output_sim_COVID[[ii]]$N))
 }

##scenaior without COVID-19 and remain##
for (ii in 1:numsims) {
output_sim_base <-list()
parasets_lists_base <- list(c(1:numsims))
parasets_lists_base[[ii]]<- c(N0= paramsSets$plhiv[ii], 
               I0=paramsSets$newinf[ii], 
               d0=paramsSets$prodiag[ii], 
               tau0=paramsSets$proART[ii], 
               sigma0=paramsSets$prosupp[ii] ,
               phi=paramsSets$effisupp[ii],  
               omega0= paramsSets$PrEPcov[ii], 
               epsilon_PrEP=paramsSets$effiPrEP[ii],  
               epsilon_condom=paramsSets$efficon[ii],   
               chi_0=paramsSets$conduse[ii], 
               alpha0=paramsSets$sexact[ii],  
               T= paramsSets$testpro[ii])
parasets_lists_base[[ii]]$beta0 <- betaoption1(parameters = parasets_lists_base[[ii]])
parasets_lists_base[[ii]]$alpha_t=c(1,paramsSets$acts_base[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_base[[ii]]$chi_t= c(1,paramsSets$condoms_base[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_base[[ii]]$T_p= c(1,paramsSets$testing_base[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_base[[ii]]$omega_p= c(1,paramsSets$prep_base[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_base[[ii]]$IM= rep(paramsSets$immigrants[((ii-1)*times+1)],times)
parasets_lists_base[[ii]]$EM= rep(paramsSets$emigrants[((ii-1)*times+1)],times)
parasets_lists_base[[ii]]$Death= rep(paramsSets$Deaths[((ii-1)*times+1)],times)
parasets_lists_base[[ii]]$tau= c(paramsSets$proART[ii],paramsSets$tau[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_base[[ii]]$sigma= c(paramsSets$prosupp[ii],paramsSets$sigma[((ii-1)*times+2):((ii-1)*times+times)])

initial_state_values_sim_base<-list()
initial_state_values_sim_base[[ii]]<-as.list(c(N=parasets_lists_base[[ii]]$N0,  
                                    I=parasets_lists_base[[ii]]$I0,
                                    d=parasets_lists_base[[ii]]$d0))
output_sim_base[[ii]]<- SimpleHIV(times=times, 
                     state = initial_state_values_sim_base[[ii]],
                     parameters = parasets_lists_base[[ii]])

infectionresults_sim<-rbind(infectionresults_sim,data.frame( 
                       timestep = c(0:(times-1)),
                       scenarios = "Without COVID-19 impact and remain",
                       numsim = ii,
                       newHIV = output_sim_base[[ii]]$I, 
                       totalHIV = output_sim_base[[ii]]$N[1:times],
                       percentage_diagnosis = output_sim_base[[ii]]$d[1:times],
                       diagnosis = output_sim_base[[ii]]$diagnosis[1:times]))

newinfectionresults_sim<-rbind(newinfectionresults_sim,data.frame( 
                       timestep = c(0:(times-1)),
                       scenarios = "Without COVID-19 impact and remain",
                       numsim = ii,
                       newHIV = output_sim_base[[ii]]$I))

totalinfectionresults_sim<-rbind(totalinfectionresults_sim,data.frame( 
                       timestep = c(0:times),
                       scenarios = "Without COVID-19 impact and remain",
                       numsim = ii,
                       totalHIV = output_sim_base[[ii]]$N))

}

##scenario Without COVID-19 impact and with prep promotion##
for (ii in 1:numsims) {
output_sim_scenario3 <-list()
parasets_lists_scenario3 <- list(c(1:numsims))
parasets_lists_scenario3[[ii]]<- c(N0= paramsSets$plhiv[ii], 
               I0=paramsSets$newinf[ii], 
               d0=paramsSets$prodiag[ii], 
               tau0=paramsSets$proART[ii], 
               sigma0=paramsSets$prosupp[ii] ,
               phi=paramsSets$effisupp[ii],  
               omega0= paramsSets$PrEPcov[ii], 
               epsilon_PrEP=paramsSets$effiPrEP[ii],  
               epsilon_condom=paramsSets$efficon[ii],   
               chi_0=paramsSets$conduse[ii], 
               alpha0=paramsSets$sexact[ii],  
               T= paramsSets$testpro[ii])
parasets_lists_scenario3[[ii]]$beta0 <- betaoption1(parameters = parasets_lists_scenario3[[ii]])
parasets_lists_scenario3[[ii]]$alpha_t=c(1,paramsSets$acts_base[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_scenario3[[ii]]$chi_t= c(1,paramsSets$condoms_scenario3[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_scenario3[[ii]]$T_p= c(1,paramsSets$testing_base[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_scenario3[[ii]]$omega_p= c(1,paramsSets$prep_scenario3[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_scenario3[[ii]]$IM= rep(paramsSets$immigrants[((ii-1)*times+1)],times)
parasets_lists_scenario3[[ii]]$EM= rep(paramsSets$emigrants[((ii-1)*times+1)],times)
parasets_lists_scenario3[[ii]]$Death= rep(paramsSets$Deaths[((ii-1)*times+1)],times)
parasets_lists_scenario3[[ii]]$tau= c(paramsSets$proART[ii],paramsSets$tau[((ii-1)*times+2):((ii-1)*times+times)])
parasets_lists_scenario3[[ii]]$sigma= c(paramsSets$prosupp[ii],paramsSets$sigma[((ii-1)*times+2):((ii-1)*times+times)])

initial_state_values_sim_scenario3<-list()
initial_state_values_sim_scenario3[[ii]]<-as.list(c(N=parasets_lists_scenario3[[ii]]$N0,  
                                    I=parasets_lists_scenario3[[ii]]$I0,
                                    d=parasets_lists_scenario3[[ii]]$d0))
output_sim_scenario3[[ii]]<- SimpleHIV(times=times, 
                     state = initial_state_values_sim_scenario3[[ii]],
                     parameters = parasets_lists_scenario3[[ii]])

infectionresults_sim<-rbind(infectionresults_sim,data.frame( 
                       timestep = c(0:(times-1)),
                       scenarios = "Without COVID-19 impact and with prep promotion",
                       numsim = ii,
                       newHIV = output_sim_scenario3[[ii]]$I, 
                       totalHIV = output_sim_scenario3[[ii]]$N[1:times],
                       percentage_diagnosis = output_sim_scenario3[[ii]]$d[1:times],
                       diagnosis = output_sim_scenario3[[ii]]$diagnosis[1:times]))

newinfectionresults_sim<-rbind(newinfectionresults_sim,data.frame( 
                       timestep = c(0:(times-1)),
                       scenarios = "Without COVID-19 impact and with prep promotion",
                       numsim = ii,
                       newHIV = output_sim_scenario3[[ii]]$I))

totalinfectionresults_sim<-rbind(totalinfectionresults_sim,data.frame( 
                       timestep = c(0:times),
                       scenarios = "Without COVID-19 impact and with prep promotion",
                       numsim = ii,
                       totalHIV = output_sim_scenario3[[ii]]$N))

}


newinfectionresults_sim<- newinfectionresults_sim %>% group_by(scenarios,numsim) %>% mutate(csum = cumsum(newHIV))

###add a colum of the variable "year" to represent###
#newinfectionresults_sim$year<-rep(c(rep("year0",3),rep("year1",12),rep("year2",12),rep("year3",6)),2000)
newinfectionresults_sim$year<-rep(c(rep(2019,1),rep(2020,12),rep(2021,12),rep(2022,8)),3000)
newinfections_peryear_sim <- newinfectionresults_sim %>%
group_by(scenarios,year,numsim) %>%
  summarise(Sum=sum(newHIV))

###for all dataset
infectionresults_sim<- infectionresults_sim %>% group_by(scenarios,numsim) %>% mutate(csum_infection = cumsum(newHIV))

###add a colum of the variable "year" to represent###
#newinfectionresults_sim$year<-rep(c(rep("year0",3),rep("year1",12),rep("year2",12),rep("year3",6)),2000)
infectionresults_sim$year<-rep(c(rep(2019,1),rep(2020,12),rep(2021,12),rep(2022,8)),3000)
infectionresults_sim <- infectionresults_sim %>%
group_by(scenarios,year,numsim) %>%
  mutate(csum_year_infection=cumsum(newHIV))
infectionresults_sim <- infectionresults_sim %>%
group_by(scenarios,year,numsim) %>%
  mutate(csum_year_diagnosis=cumsum(diagnosis))

##select 5%-95% data at each timestep.##
##use one loop to filter all results for new infection##
quantile_interval_newHIV<-data.frame( 
                       timestep = integer(),
                       lowerbound_withCOVID = numeric(),
                       upperbound_withCOVID = numeric(),
                       lowerbound_withoutCOVID = numeric(),
                       upperbound_withoutCOVID = numeric(),
                       lowerbound_withoutCOVID_withprep = numeric(),
                       upperbound_withoutCOVID_withprep = numeric())
infectionresults_sim_filter_newHIV <- infectionresults_sim
for (ii in 1:(times)) {
quantile_interval_newHIV<-rbind(quantile_interval_newHIV,data.frame(timestep = ii-1,
                   lowerbound_withCOVID =  quantile((infectionresults_sim %>% filter(scenarios == "With COVID-19 impact", timestep == ii-1))$newHIV, probs = 0.025, names = FALSE),
                   upperbound_withCOVID = quantile((infectionresults_sim %>% filter(scenarios == "With COVID-19 impact", timestep == ii-1))$newHIV, probs = 0.975, names = FALSE),
                   lowerbound_withoutCOVID =  quantile((infectionresults_sim %>% filter(scenarios == "Without COVID-19 impact and remain", timestep == ii-1))$newHIV, probs = 0.025, names = FALSE),
                   upperbound_withoutCOVID = quantile((infectionresults_sim %>% filter(scenarios == "Without COVID-19 impact and remain", timestep == ii-1))$newHIV, probs = 0.975, names = FALSE),
                   lowerbound_withoutCOVID_withprep =  quantile((infectionresults_sim %>% filter(scenarios == "Without COVID-19 impact and with prep promotion", timestep == ii-1))$newHIV, probs = 0.025, names = FALSE),
                   upperbound_withoutCOVID_withprep = quantile((infectionresults_sim %>% filter(scenarios == "Without COVID-19 impact and with prep promotion", timestep == ii-1))$newHIV, probs = 0.975, names = FALSE)))
infectionresults_sim_filter_newHIV<-infectionresults_sim_filter_newHIV[(infectionresults_sim_filter_newHIV$scenarios == "With COVID-19 impact" & 
                                                                    infectionresults_sim_filter_newHIV$timestep == ii-1 & 
                                                            infectionresults_sim_filter_newHIV$newHIV > quantile_interval_newHIV$lowerbound_withCOVID[ii] &
                                                            infectionresults_sim_filter_newHIV$newHIV < quantile_interval_newHIV$upperbound_withCOVID[ii])|
                                                           (infectionresults_sim_filter_newHIV$scenarios == "With COVID-19 impact" & infectionresults_sim_filter_newHIV$timestep != ii-1)|
                                                           (infectionresults_sim_filter_newHIV$scenarios == "Without COVID-19 impact and remain" & 
                                                                    infectionresults_sim_filter_newHIV$timestep == ii-1 & 
                                                            infectionresults_sim_filter_newHIV$newHIV > quantile_interval_newHIV$lowerbound_withoutCOVID[ii] &
                                                            infectionresults_sim_filter_newHIV$newHIV < quantile_interval_newHIV$upperbound_withoutCOVID[ii])|
                                                           (infectionresults_sim_filter_newHIV$scenarios == "Without COVID-19 impact and remain" & infectionresults_sim_filter_newHIV$timestep != ii-1)|
                                                           (infectionresults_sim_filter_newHIV$scenarios == "Without COVID-19 impact and with prep promotion" & 
                                                                    infectionresults_sim_filter_newHIV$timestep == ii-1 & 
                                                            infectionresults_sim_filter_newHIV$newHIV > quantile_interval_newHIV$lowerbound_withoutCOVID_withprep[ii] &
                                                            infectionresults_sim_filter_newHIV$newHIV < quantile_interval_newHIV$upperbound_withoutCOVID_withprep[ii])|
                                                           (infectionresults_sim_filter_newHIV$scenarios == "Without COVID-19 impact and with prep promotion" & infectionresults_sim_filter_newHIV$timestep != ii-1),]
}
infectionresults_sim_filter_newHIV<- infectionresults_sim_filter_newHIV %>% group_by(numsim,scenarios) %>% filter(n() > 32)

##use one loop to filter all results for total infection##
quantile_interval_totalHIV<-data.frame( 
                       timestep = integer(),
                       lowerbound_withCOVID = numeric(),
                       upperbound_withCOVID = numeric(),
                       lowerbound_withoutCOVID = numeric(),
                       upperbound_withoutCOVID = numeric(),
                       lowerbound_withoutCOVID_withprep = numeric(),
                       upperbound_withoutCOVID_withprep = numeric())
infectionresults_sim_filter_totalHIV <- infectionresults_sim
for (ii in 1:(times)) {
quantile_interval_totalHIV<-rbind(quantile_interval_totalHIV,data.frame(timestep = ii-1,
                   lowerbound_withCOVID =  quantile((infectionresults_sim %>% filter(scenarios == "With COVID-19 impact", timestep == ii-1))$totalHIV, probs = 0.025, names = FALSE),
                   upperbound_withCOVID = quantile((infectionresults_sim %>% filter(scenarios == "With COVID-19 impact", timestep == ii-1))$totalHIV, probs = 0.975, names = FALSE),
                   lowerbound_withoutCOVID =  quantile((infectionresults_sim %>% filter(scenarios == "Without COVID-19 impact and remain", timestep == ii-1))$totalHIV, probs = 0.025, names = FALSE),
                   upperbound_withoutCOVID = quantile((infectionresults_sim %>% filter(scenarios == "Without COVID-19 impact and remain", timestep == ii-1))$totalHIV, probs = 0.975, names = FALSE),
                   lowerbound_withoutCOVID_withprep =  quantile((infectionresults_sim %>% filter(scenarios == "Without COVID-19 impact and with prep promotion", timestep == ii-1))$totalHIV, probs = 0.025, names = FALSE),
                   upperbound_withoutCOVID_withprep = quantile((infectionresults_sim %>% filter(scenarios == "Without COVID-19 impact and with prep promotion", timestep == ii-1))$totalHIV, probs = 0.975, names = FALSE)))
infectionresults_sim_filter_totalHIV<-infectionresults_sim_filter_totalHIV[(infectionresults_sim_filter_totalHIV$scenarios == "With COVID-19 impact" & 
                                                                    infectionresults_sim_filter_totalHIV$timestep == ii-1 & 
                                                            infectionresults_sim_filter_totalHIV$totalHIV > quantile_interval_totalHIV$lowerbound_withCOVID[ii] &
                                                            infectionresults_sim_filter_totalHIV$totalHIV < quantile_interval_totalHIV$upperbound_withCOVID[ii])|
                                                           (infectionresults_sim_filter_totalHIV$scenarios == "With COVID-19 impact" & infectionresults_sim_filter_totalHIV$timestep != ii-1)|
                                                           (infectionresults_sim_filter_totalHIV$scenarios == "Without COVID-19 impact and remain" & 
                                                                    infectionresults_sim_filter_totalHIV$timestep == ii-1 & 
                                                            infectionresults_sim_filter_totalHIV$totalHIV > quantile_interval_totalHIV$lowerbound_withoutCOVID[ii] &
                                                            infectionresults_sim_filter_totalHIV$totalHIV < quantile_interval_totalHIV$upperbound_withoutCOVID[ii])|
                                                           (infectionresults_sim_filter_totalHIV$scenarios == "Without COVID-19 impact and remain" & infectionresults_sim_filter_totalHIV$timestep != ii-1)|
                                                             (infectionresults_sim_filter_totalHIV$scenarios == "Without COVID-19 impact and with prep promotion" & 
                                                                    infectionresults_sim_filter_totalHIV$timestep == ii-1 & 
                                                            infectionresults_sim_filter_totalHIV$totalHIV > quantile_interval_totalHIV$lowerbound_withoutCOVID_withprep[ii] &
                                                            infectionresults_sim_filter_totalHIV$totalHIV < quantile_interval_totalHIV$upperbound_withoutCOVID_withprep[ii])|
                                                           (infectionresults_sim_filter_totalHIV$scenarios == "Without COVID-19 impact and with prep promotion" & infectionresults_sim_filter_totalHIV$timestep != ii-1),]
}
infectionresults_sim_filter_totalHIV<- infectionresults_sim_filter_totalHIV %>% group_by(numsim,scenarios) %>% filter(n() > 32)


library(tidyverse)
avertedInfects_95PI<-list()
avertedInfects_95PI$value <- (totalinfectionresults %>% 
  spread(scenarios, totalHIV) %>%
  mutate(avertednum =  `Without COVID-19 impact and remain` - `With COVID-19 impact`)%>% 
  filter(timestep == 33))$avertednum
avertedInfects_95PI$upper <- quantile((totalinfectionresults_sim %>% 
  spread(scenarios, totalHIV) %>%
  mutate(avertednum =  `Without COVID-19 impact and remain` - `With COVID-19 impact`)%>%
  filter(timestep == 33))$avertednum, probs = 0.975, names = FALSE)
avertedInfects_95PI$lower <- quantile((totalinfectionresults_sim %>% 
  spread(scenarios, totalHIV) %>%
  mutate(avertednum =  `Without COVID-19 impact and remain` - `With COVID-19 impact`)%>%
  filter(timestep == 33))$avertednum, probs = 0.025, names = FALSE)

totalinfectionresults_95PI<-list()
totalinfectionresults_95PI$withoutcovid_value<-round((totalinfectionresults %>% filter(scenarios =="Without COVID-19 impact and remain",timestep == 33))$totalHIV,0)
totalinfectionresults_95PI$withoutcovid_upper<-round(quantile((totalinfectionresults_sim %>% filter(scenarios == "Without COVID-19 impact and remain", timestep == 33))$totalHIV, probs = 0.975, names = FALSE),0)
totalinfectionresults_95PI$withoutcovid_lower<-round(quantile((totalinfectionresults_sim %>% filter(scenarios == "Without COVID-19 impact and remain", timestep == 33))$totalHIV, probs = 0.025, names = FALSE),0)

totalinfectionresults_95PI$withcovid_value<-round((totalinfectionresults %>% filter(scenarios == "With COVID-19 impact",timestep == 33))$totalHIV,0)
totalinfectionresults_95PI$withcovid_upper<-round(quantile((totalinfectionresults_sim %>% filter(scenarios == "With COVID-19 impact", timestep == 33))$totalHIV, probs = 0.975, names = FALSE),0)
totalinfectionresults_95PI$withcovid_lower<-round(quantile((totalinfectionresults_sim %>% filter(scenarios == "With COVID-19 impact", timestep == 33))$totalHIV, probs = 0.025, names = FALSE),0)
totalinfectionresults_95PI

cumuinfectionresults_95PI<-list()
cumuinfectionresults_95PI$withoutcovid_value<-round((newinfectionresults %>% filter(scenarios =="Without COVID-19 impact and remain",timestep == 32))$csum,0)
cumuinfectionresults_95PI$withoutcovid_upper<-round(quantile((newinfectionresults_sim %>% filter(scenarios == "Without COVID-19 impact and remain", timestep == 32))$csum, probs = 0.975, names = FALSE),0)
cumuinfectionresults_95PI$withoutcovid_lower<-round(quantile((newinfectionresults_sim %>% filter(scenarios == "Without COVID-19 impact and remain", timestep == 32))$csum, probs = 0.025, names = FALSE),0)

cumuinfectionresults_95PI$withcovid_value<-round((newinfectionresults %>% filter(scenarios == "With COVID-19 impact",timestep == 32))$csum,0)
cumuinfectionresults_95PI$withcovid_upper<-round(quantile((newinfectionresults_sim %>% filter(scenarios == "With COVID-19 impact", timestep == 32))$csum, probs = 0.975, names = FALSE),0)
cumuinfectionresults_95PI$withcovid_lower<-round(quantile((newinfectionresults_sim %>% filter(scenarios == "With COVID-19 impact", timestep == 32))$csum, probs = 0.025, names = FALSE),0)
cumuinfectionresults_95PI

newinfectionresults_peryear_95PI<-list()
newinfectionresults_peryear_95PI$withoutcovid_value_2020<-round((newinfections_peryear %>% filter(scenarios =="Without COVID-19 impact and remain",year == 2020))$Sum,0)
newinfectionresults_peryear_95PI$withoutcovid_upper_2020<-round(quantile((newinfections_peryear_sim %>% filter(scenarios == "Without COVID-19 impact and remain", year ==2020))$Sum, probs = 0.975, names = FALSE),0)
newinfectionresults_peryear_95PI$withoutcovid_lower_2020<-round(quantile((newinfections_peryear_sim %>% filter(scenarios == "Without COVID-19 impact and remain", year ==2020))$Sum, probs = 0.025, names = FALSE),0)
newinfectionresults_peryear_95PI$withoutcovid_value_2021<-round((newinfections_peryear %>% filter(scenarios =="Without COVID-19 impact and remain",year == 2021))$Sum,0)
newinfectionresults_peryear_95PI$withoutcovid_upper_2021<-round(quantile((newinfections_peryear_sim %>% filter(scenarios == "Without COVID-19 impact and remain", year ==2021))$Sum, probs = 0.975, names = FALSE),0)
newinfectionresults_peryear_95PI$withoutcovid_lower_2021<-round(quantile((newinfections_peryear_sim %>% filter(scenarios == "Without COVID-19 impact and remain", year ==2021))$Sum, probs = 0.025, names = FALSE),0)
newinfectionresults_peryear_95PI$withoutcovid_value_2022<-round((newinfections_peryear %>% filter(scenarios =="Without COVID-19 impact and remain",year == 2022))$Sum,0)
newinfectionresults_peryear_95PI$withoutcovid_upper_2022<-round(quantile((newinfections_peryear_sim %>% filter(scenarios == "Without COVID-19 impact and remain", year ==2022))$Sum, probs = 0.975, names = FALSE),0)
newinfectionresults_peryear_95PI$withoutcovid_lower_2022<-round(quantile((newinfections_peryear_sim %>% filter(scenarios == "Without COVID-19 impact and remain", year ==2022))$Sum, probs = 0.025, names = FALSE),0)

newinfectionresults_peryear_95PI$withcovid_value_2020<-round((newinfections_peryear %>% filter(scenarios =="With COVID-19 impact",year == 2020))$Sum,0)
newinfectionresults_peryear_95PI$withcovid_upper_2020<-round(quantile((newinfections_peryear_sim %>% filter(scenarios == "With COVID-19 impact", year ==2020))$Sum, probs = 0.975, names = FALSE),0)
newinfectionresults_peryear_95PI$withcovid_lower_2020<-round(quantile((newinfections_peryear_sim %>% filter(scenarios == "With COVID-19 impact", year ==2020))$Sum, probs = 0.025, names = FALSE),0)
newinfectionresults_peryear_95PI$withcovid_value_2021<-round((newinfections_peryear %>% filter(scenarios =="With COVID-19 impact",year == 2021))$Sum,0)
newinfectionresults_peryear_95PI$withcovid_upper_2021<-round(quantile((newinfections_peryear_sim %>% filter(scenarios == "With COVID-19 impact", year ==2021))$Sum, probs = 0.975, names = FALSE),0)
newinfectionresults_peryear_95PI$withcovid_lower_2021<-round(quantile((newinfections_peryear_sim %>% filter(scenarios == "With COVID-19 impact", year ==2021))$Sum, probs = 0.025, names = FALSE),0)
newinfectionresults_peryear_95PI$withcovid_value_2022<-round((newinfections_peryear %>% filter(scenarios =="With COVID-19 impact",year == 2022))$Sum,0)
newinfectionresults_peryear_95PI$withcovid_upper_2022<-round(quantile((newinfections_peryear_sim %>% filter(scenarios == "With COVID-19 impact", year ==2022))$Sum, probs = 0.975, names = FALSE),0)
newinfectionresults_peryear_95PI$withcovid_lower_2022<-round(quantile((newinfections_peryear_sim %>% filter(scenarios == "With COVID-19 impact", year ==2022))$Sum, probs = 0.025, names = FALSE),0)
newinfectionresults_peryear_95PI
```

